<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兑换码管理后台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            padding: 20px;
        }

        .header {
            background: #ffffff;
            padding: 24px 32px;
            border-radius: 16px;
            border: 1px solid #e5e5e5;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #1d1d1f;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #000000;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #1d1d1f;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #ffffff;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid #e5e5e5;
        }

        .stat-card h3 {
            color: #86868b;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .number {
            color: #1d1d1f;
            font-size: 36px;
            font-weight: 600;
            letter-spacing: -1px;
        }

        .stat-card .subtext {
            margin-top: 8px;
            color: #86868b;
            font-size: 13px;
            line-height: 1.4;
        }

        .tabs {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e5e5e5;
            overflow: hidden;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .tab-btn {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #86868b;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: #ffffff;
            color: #1d1d1f;
        }

        .tab-btn:hover {
            color: #1d1d1f;
        }

        .tab-content {
            padding: 24px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e5e5;
        }

        th {
            background: #fafafa;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #fafafa;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge.success {
            background: #f0f9f4;
            color: #1d4428;
        }

        .badge.warning {
            background: #fff9f0;
            color: #6e4a1e;
        }

        .badge.danger {
            background: #fff0f0;
            color: #6e1616;
        }

        .badge.info {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-left {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-right {
            margin-left: auto;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 10px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            font-size: 14px;
            background: #fafafa;
            color: #1d1d1f;
            transition: all 0.2s ease;
        }

        .filter-bar select:focus {
            outline: none;
            border-color: #000000;
            background: #ffffff;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #000000;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background: #1d1d1f;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
            font-size: 15px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .action-btn.disable {
            background: #f5f5f7;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
        }

        .action-btn.disable:hover {
            background: #e5e5e5;
        }

        .action-btn.enable {
            background: #000000;
            color: white;
        }

        .action-btn.enable:hover {
            background: #1d1d1f;
        }

        .action-btn.danger {
            background: #ff3b30;
            color: white;
        }

        .action-btn.danger:hover {
            background: #e0352b;
        }

        code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            background: #f5f5f7;
            padding: 3px 6px;
            border-radius: 4px;
        }

        .copyable {
            cursor: pointer;
            user-select: none;
        }

        .copyable:hover {
            background: #e5e5e5;
        }

        .team-cell {
            max-width: min(320px, 35vw);
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: bottom;
        }

        .filter-label {
            font-size: 13px;
            color: #86868b;
            margin-right: -6px;
        }

        .ui-toast {
            position: fixed;
            top: 30%;
            left: 50%;
            right: auto;
            bottom: auto;
            transform: translate(-50%, -50%);
            z-index: 3000;
            background: rgba(0, 0, 0, 0.82);
            color: #fff;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            max-width: min(420px, 92vw);
            text-align: center;
            display: none;
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .ui-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .ui-modal {
            background: #fff;
            border-radius: 16px;
            width: min(560px, 92vw);
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            overflow: hidden;
        }

        .ui-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e5;
            font-weight: 600;
            color: #1d1d1f;
        }

        .ui-modal-body {
            padding: 16px 20px;
            color: #1d1d1f;
            font-size: 14px;
            line-height: 1.6;
        }

        .ui-modal-actions {
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .ui-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            font-size: 14px;
            background: #fff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>兑换码管理后台</h1>
        <a href="/admin/logout" class="logout-btn">退出登录</a>
    </div>

    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <h3>兑换码总数</h3>
            <div class="number" id="totalCodes">-</div>
            <div class="subtext" id="codesBreakdown">-</div>
        </div>
        <div class="stat-card">
            <h3>可用兑换码</h3>
            <div class="number" id="activeCodes">-</div>
            <div class="subtext" id="activeCodesHint">状态=active</div>
        </div>
        <div class="stat-card">
            <h3>兑换请求</h3>
            <div class="number" id="totalRedemptions">-</div>
            <div class="subtext" id="redemptionsBreakdown">-</div>
        </div>
        <div class="stat-card">
            <h3>成功率</h3>
            <div class="number" id="successRate">-</div>
            <div class="subtext" id="successRateHint">-</div>
        </div>
        <div class="stat-card">
            <h3>今日成功</h3>
            <div class="number" id="todaySuccess">-</div>
            <div class="subtext" id="todayBreakdown">-</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab(event, 'codes')">兑换码管理</button>
            <button class="tab-btn" onclick="switchTab(event, 'redemptions')">兑换记录</button>
            <button class="tab-btn" onclick="switchTab(event, 'teams')">Team统计</button>
            <button class="tab-btn" onclick="switchTab(event, 'teamManagement')">Team管理</button>
            <button class="tab-btn" onclick="switchTab(event, 'leases')">到期/转移</button>
        </div>

        <div class="tab-content">
            <!-- 兑换码管理 -->
            <div id="codes" class="tab-pane active">
                <div class="filter-bar">
                    <div class="filter-left">
                        <span class="filter-label">Team</span>
                        <select id="teamFilter" onchange="loadCodes()">
                            <option value="">所有Team</option>
                        </select>
                        <span class="filter-label">状态</span>
                        <select id="statusFilter" onchange="loadCodes()">
                            <option value="">所有状态</option>
                            <option value="active">激活</option>
                            <option value="disabled">禁用</option>
                            <option value="expired">过期</option>
                        </select>
                    </div>
                    <div class="filter-right">
                        <button class="refresh-btn" onclick="loadCodes({ force: true })">刷新</button>
                        <button class="action-btn danger" onclick="bulkDeleteCodes()">全部删除</button>
                    </div>
                </div>

                <div id="codesTable">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 兑换记录 -->
            <div id="redemptions" class="tab-pane">
                <div class="filter-bar">
                    <div class="filter-left"></div>
                    <div class="filter-right">
                        <button class="refresh-btn" onclick="loadRedemptions({ force: true })">刷新</button>
                        <button class="action-btn danger" onclick="bulkDeleteRedemptions()">全部删除</button>
                    </div>
                </div>

                <div id="redemptionsTable">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- Team统计 -->
            <div id="teams" class="tab-pane">
                <div class="filter-bar">
                    <div class="filter-left"></div>
                    <div class="filter-right">
                        <button class="refresh-btn" onclick="refreshTeamStats()">刷新统计</button>
                        <button class="refresh-btn" onclick="loadTeamStats({ force: true })">重新加载</button>
                    </div>
                </div>

                <div id="teamsTable">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- Team管理 -->
            <div id="teamManagement" class="tab-pane">
                <div class="filter-bar">
                    <div class="filter-left"></div>
                    <div class="filter-right">
                        <button class="refresh-btn" onclick="addTeam()">添加Team</button>
                        <button class="refresh-btn" onclick="loadTeamList({ force: true })">刷新</button>
                    </div>
                </div>

                <div id="teamListTable">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 到期转移 / 成员租约 -->
            <div id="leases" class="tab-pane">
                <div class="filter-bar">
                    <div class="filter-left">
                        <span class="filter-label">邮箱</span>
                        <input id="leaseEmailFilter" class="ui-input" style="width: 280px; max-width: 70vw;" placeholder="输入邮箱（可选，用于查看事件/单邮箱同步）" />
                    </div>
                <div class="filter-right">
                        <button class="refresh-btn" onclick="loadLeases({ force: true })" title="刷新列表">刷新</button>
                    </div>
                </div>

                <div id="leasesTable">
                    <div class="loading">加载中...</div>
                </div>

                <div style="margin-top: 16px;">
                    <div style="color:#86868b; font-size: 13px; line-height: 1.6;">
                        提示：到期计算以 <code>join_at</code>（加入时间）为准；若状态为“待同步加入时间”，表示还未拿到准确加入时间。
                    </div>
                    <div id="leaseEventsTable" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team 添加/编辑对话框 -->
    <div id="teamModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 24px; color: #1d1d1f; font-size: 24px; font-weight: 600;" id="modalTitle">添加Team</h2>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">Team 名称</label>
                <input type="text" id="teamName" placeholder="例如：yulisutari（建议英文/数字/短横线，且唯一）" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">邮箱</label>
                <input type="email" id="teamEmail" placeholder="team@example.com" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">User ID</label>
                <input type="text" id="teamUserId" placeholder="user-xxxxxxxx" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">Account ID</label>
                <input type="text" id="teamAccountId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">Organization ID</label>
                <input type="text" id="teamOrgId" placeholder="org-xxxxxxxx" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">Access Token <span style="color: #86868b; font-weight: 400;">(可选，编辑时不填则不更新)</span></label>
                <textarea id="teamAccessToken" rows="4" placeholder="eyJhbGci..." style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 13px; font-family: 'SF Mono', Monaco, monospace;"></textarea>
                <div style="margin-top: 8px; font-size: 13px; color: #86868b;">
                    提示: 访问
                    <span class="copyable" data-copy="https://chatgpt.com/api/auth/session" title="点击复制" style="color:#000; cursor:pointer; text-decoration:underline;">https://chatgpt.com/api/auth/session</span>
                    获取 accessToken（点击链接复制）
                    <a href="https://chatgpt.com/api/auth/session" target="_blank" style="color:#86868b; margin-left:6px;">打开</a>
                </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeTeamModal()" style="padding: 12px 24px; background: #f5f5f7; color: #1d1d1f; border: none; border-radius: 10px; cursor: pointer; font-weight: 500;">取消</button>
                <button onclick="saveTeam()" style="padding: 12px 24px; background: #000000; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 500;">保存</button>
            </div>
        </div>
    </div>

    <!-- 兑换码生成对话框 -->
    <div id="generateCodesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 500px;">
            <h2 style="margin-bottom: 24px; color: #1d1d1f; font-size: 24px; font-weight: 600;">生成兑换码</h2>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">Team</label>
                <input type="text" id="genTeamName" readonly style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px; background: #f5f5f7;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">生成数量</label>
                <input type="number" id="genCount" value="10" min="1" max="100" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">最大使用次数</label>
                <input type="number" id="genMaxUses" value="1" min="1" max="100" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; color: #1d1d1f; font-weight: 500;">有效期(天) <span style="color: #86868b; font-weight: 400;">(留空表示永久)</span></label>
                <input type="number" id="genExpiresDays" placeholder="留空表示永久有效" min="1" style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 10px; font-size: 14px;">
            </div>

            <div style="margin-bottom: 24px; padding: 16px; background: #f5f5f7; border-radius: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="genAutoTransfer" checked style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                    <div>
                        <div style="color: #1d1d1f; font-weight: 500; margin-bottom: 4px;">启用自动转移</div>
                        <div style="color: #86868b; font-size: 13px; line-height: 1.4;">取消勾选后，使用该兑换码的用户将成为VIP用户，永久使用当前Team，不参与按月自动转移</div>
                    </div>
                </label>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeGenerateCodesModal()" style="padding: 12px 24px; background: #f5f5f7; color: #1d1d1f; border: none; border-radius: 10px; cursor: pointer; font-weight: 500;">取消</button>
                <button onclick="generateCodes()" style="padding: 12px 24px; background: #000000; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 500;">生成</button>
            </div>
        </div>
    </div>

    <div id="uiToast" class="ui-toast"></div>

    <div id="uiModalOverlay" class="ui-modal-overlay">
        <div class="ui-modal" role="dialog" aria-modal="true">
            <div id="uiModalTitle" class="ui-modal-header">提示</div>
            <div id="uiModalBody" class="ui-modal-body"></div>
            <div class="ui-modal-actions" id="uiModalActions"></div>
        </div>
    </div>

    <script>
        // 切换标签页
        function switchTab(evt, tabName) {
            // 更新按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }

            // 更新内容显示
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // 加载对应数据
            if (tabName === 'codes') {
                loadTeamFilterOptions({ force: true });
                loadCodes({ force: true });
                loadStats({ force: true });
            }
            else if (tabName === 'redemptions') loadRedemptions();
            else if (tabName === 'teams') loadTeamStats();
            else if (tabName === 'teamManagement') loadTeamList();
            else if (tabName === 'leases') loadLeases();
        }

        // ==================== 简单缓存（减少切换 Tab 时的重复请求卡顿） ====================
        const CACHE_TTL_MS = {
            stats: 15000,
            teams: 15000,
            codes: 8000,
            redemptions: 8000,
            leases: 8000,
            leaseEvents: 8000,
        };

        const cacheState = {
            stats: { ts: 0, data: null, promise: null },
            teams: { ts: 0, data: null, promise: null },
            redemptions: { ts: 0, data: null, promise: null },
            leases: { ts: 0, data: null, promise: null },
            leaseEvents: new Map(), // email -> { ts, data, promise }
            codes: new Map(), // key -> { ts, data, promise }
        };

        // ==================== UI 提示/弹窗（居中显示） ====================
        const UI_CONFIRM_PHRASE = 'DELLT';

        // ==================== 文案/状态中文化（只影响展示，不影响后端存储） ====================
        const LABELS = {
            codeStatus: {
                active: '激活',
                disabled: '禁用',
                expired: '过期',
                used_up: '已用完',
                deleted: '已删除',
            },
            inviteStatus: {
                success: '成功',
                failed: '失败',
                inviting: '邀请中',
                pending: '待处理',
            },
            leaseStatus: {
                awaiting_join: '待同步加入时间',
                active: '生效中',
                awaiting_transfer: '待转移',
                transferring: '转移中',
            },
            leaseAction: {
                created: '创建租约',
                manual_upsert: '手动录入/更新',
                joined: '已同步加入时间',
                joined_fallback: '已加入（近似时间）',
                joined_fallback_manual: '已加入（管理员近似）',
                sync_invite_status: '邀请状态未完成',
                sync_invite_error: '拉取邀请失败',
                sync_member_error: '拉取成员失败',
                sync_member_no_time: '成员记录无加入时间',
                sync_not_joined: '未检测到已加入',
                left_old_team: '已退出旧团队',
                leave_old_failed: '退出旧团队失败',
                transferred: '已发送新团队邀请',
                transfer_failed: '转移失败',
                force_expire: '强制到期（测试）',
            },
        };

        function labelOf(map, key, fallback = '') {
            if (!key) return fallback;
            return (map && map[key]) ? map[key] : fallback;
        }

        function escapeHtml(str) {
            return String(str ?? '').replace(/[&<>"']/g, (m) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        async function copyText(text) {
            const t = String(text ?? '');
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(t);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = t;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                showToast('已复制', 'success');
            } catch (e) {
                showToast('复制失败，请手动复制', 'danger');
            }
        }

        function showToast(message, type = 'info', timeoutMs = 1400) {
            const el = document.getElementById('uiToast');
            if (!el) return;
            el.textContent = message;
            el.style.display = 'block';
            if (type === 'danger') el.style.background = 'rgba(255, 59, 48, 0.92)';
            else if (type === 'success') el.style.background = 'rgba(0, 0, 0, 0.82)';
            else el.style.background = 'rgba(0, 0, 0, 0.82)';
            clearTimeout(showToast._t);
            showToast._t = setTimeout(() => { el.style.display = 'none'; }, timeoutMs);
        }

        function openModal({ title = '提示', bodyHtml = '', actions = [] }) {
            const overlay = document.getElementById('uiModalOverlay');
            const titleEl = document.getElementById('uiModalTitle');
            const bodyEl = document.getElementById('uiModalBody');
            const actionsEl = document.getElementById('uiModalActions');
            if (!overlay || !titleEl || !bodyEl || !actionsEl) return;

            titleEl.textContent = title;
            bodyEl.innerHTML = bodyHtml;
            actionsEl.innerHTML = '';
            actions.forEach((a) => actionsEl.appendChild(a));

            overlay.style.display = 'flex';
        }

        function closeModal() {
            const overlay = document.getElementById('uiModalOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        function makeButton({ text, className = 'refresh-btn', onClick }) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = className;
            btn.onclick = onClick;
            return btn;
        }

        function uiAlert(message, { title = '提示' } = {}) {
            return new Promise((resolve) => {
                const ok = makeButton({
                    text: '确定',
                    className: 'refresh-btn',
                    onClick: () => { closeModal(); resolve(true); }
                });
                openModal({
                    title,
                    bodyHtml: `<div>${escapeHtml(message)}</div>`,
                    actions: [ok]
                });
            });
        }

        function uiConfirm(message, { title = '确认', okText = '确定', cancelText = '取消' } = {}) {
            return new Promise((resolve) => {
                const cancel = makeButton({
                    text: cancelText,
                    className: 'action-btn disable',
                    onClick: () => { closeModal(); resolve(false); }
                });
                const ok = makeButton({
                    text: okText,
                    className: 'refresh-btn',
                    onClick: () => { closeModal(); resolve(true); }
                });
                openModal({
                    title,
                    bodyHtml: `<div>${escapeHtml(message)}</div>`,
                    actions: [cancel, ok]
                });
            });
        }

        function uiConfirmPhrase({ title, message, phrase = UI_CONFIRM_PHRASE }) {
            return new Promise((resolve) => {
                const safePhrase = escapeHtml(phrase);
                const bodyHtml = `
                    <div style="margin-bottom: 12px;">${escapeHtml(message)}</div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom: 12px;">
                        <code class="copyable" onclick="copyText('${phrase}')">${safePhrase}</code>
                        <button class="action-btn enable" onclick="copyText('${phrase}')">复制口令</button>
                    </div>
                    <input id="uiConfirmInput" class="ui-input" placeholder="粘贴/输入上方口令确认" />
                `;

                const cancel = makeButton({
                    text: '取消',
                    className: 'action-btn disable',
                    onClick: () => { closeModal(); resolve(false); }
                });
                const ok = makeButton({
                    text: '确认删除',
                    className: 'action-btn danger',
                    onClick: () => {
                        const v = (document.getElementById('uiConfirmInput')?.value || '').trim();
                        if (v !== phrase) {
                            showToast('口令不正确', 'danger');
                            return;
                        }
                        closeModal();
                        resolve(true);
                    }
                });

                openModal({ title, bodyHtml, actions: [cancel, ok] });
                setTimeout(() => document.getElementById('uiConfirmInput')?.focus(), 0);
            });
        }

        async function fetchJson(url, options) {
            const response = await fetch(url, options);
            const result = await response.json();
            if (!response.ok || !result || result.success === false) {
                throw new Error((result && (result.error || result.message)) || `请求失败: ${response.status}`);
            }
            return result;
        }

        // 点击兑换码复制（事件委托）
        document.addEventListener('click', (e) => {
            const el = e.target && e.target.closest ? e.target.closest('.copyable[data-copy]') : null;
            if (!el) return;
            const text = el.getAttribute('data-copy');
            if (text) copyText(text);
        });

        // Team 管理按钮事件委托（避免 inline onclick 的引号问题）
        document.addEventListener('click', (e) => {
            const btn = e.target && e.target.closest ? e.target.closest('button[data-team-action]') : null;
            if (!btn) return;
            const action = (btn.getAttribute('data-team-action') || '').trim();
            const idx = parseInt(btn.getAttribute('data-index') || '', 10);
            const name = (btn.getAttribute('data-team-name') || '').trim();
            if (!Number.isFinite(idx)) return;

            if (action === 'edit') editTeam(idx);
            else if (action === 'generate') showGenerateCodesModal(idx, name);
            else if (action === 'delete') deleteTeam(idx, name);
        }, true);

        function isFresh(entry, ttlMs) {
            return entry && entry.data && (Date.now() - entry.ts) < ttlMs;
        }

        async function getStats({ force = false } = {}) {
            const entry = cacheState.stats;
            if (!force && isFresh(entry, CACHE_TTL_MS.stats)) return entry.data;
            if (!force && entry.promise) return entry.promise;

            entry.promise = fetchJson('/api/admin/stats').then((result) => {
                entry.data = result.data;
                entry.ts = Date.now();
                return entry.data;
            }).finally(() => {
                entry.promise = null;
            });

            return entry.promise;
        }

        async function getTeams({ force = false } = {}) {
            const entry = cacheState.teams;
            if (!force && isFresh(entry, CACHE_TTL_MS.teams)) return entry.data;
            if (!force && entry.promise) return entry.promise;

            entry.promise = fetchJson('/api/admin/teams').then((result) => {
                entry.data = result.data;
                entry.ts = Date.now();
                return entry.data;
            }).finally(() => {
                entry.promise = null;
            });

            return entry.promise;
        }

        async function getCodes({ team = '', status = '', includeDeleted = false, force = false } = {}) {
            const key = `${team}|${status}|${includeDeleted ? '1' : '0'}`;
            const entry = cacheState.codes.get(key) || { ts: 0, data: null, promise: null };

            if (!force && isFresh(entry, CACHE_TTL_MS.codes)) return entry.data;
            if (!force && entry.promise) return entry.promise;

            let url = '/api/admin/codes?';
            if (team) url += `team=${encodeURIComponent(team)}&`;
            if (status) url += `status=${encodeURIComponent(status)}&`;
            if (includeDeleted) url += 'include_deleted=true&';

            entry.promise = fetchJson(url).then((result) => {
                entry.data = result.data;
                entry.ts = Date.now();
                cacheState.codes.set(key, entry);
                return entry.data;
            }).finally(() => {
                entry.promise = null;
            });

            cacheState.codes.set(key, entry);
            return entry.promise;
        }

        async function getRedemptions({ limit = 50, force = false } = {}) {
            const entry = cacheState.redemptions;
            if (!force && isFresh(entry, CACHE_TTL_MS.redemptions)) return entry.data;
            if (!force && entry.promise) return entry.promise;

            entry.promise = fetchJson(`/api/admin/redemptions?limit=${limit}`).then((result) => {
                entry.data = result.data;
                entry.ts = Date.now();
                return entry.data;
            }).finally(() => {
                entry.promise = null;
            });

            return entry.promise;
        }

        async function getLeases({ limit = 100, force = false } = {}) {
            const entry = cacheState.leases;
            if (!force && isFresh(entry, CACHE_TTL_MS.leases)) return entry.data;
            if (!force && entry.promise) return entry.promise;

            entry.promise = fetchJson(`/api/admin/leases?limit=${limit}`).then((result) => {
                entry.data = result.data;
                entry.ts = Date.now();
                return entry.data;
            }).finally(() => {
                entry.promise = null;
            });

            return entry.promise;
        }

        async function getLeaseEvents({ email = '', limit = 200, force = false } = {}) {
            const key = (email || '').trim().toLowerCase() || '__all__';
            let entry = cacheState.leaseEvents.get(key);
            if (!entry) entry = { ts: 0, data: null, promise: null };
            if (!force && isFresh(entry, CACHE_TTL_MS.leaseEvents)) return entry.data;
            if (!force && entry.promise) return entry.promise;

            const qs = new URLSearchParams({ limit: String(limit) });
            if (key !== '__all__') qs.set('email', key);

            entry.promise = fetchJson(`/api/admin/leases/events?${qs.toString()}`).then((result) => {
                entry.data = result.data;
                entry.ts = Date.now();
                cacheState.leaseEvents.set(key, entry);
                return entry.data;
            }).finally(() => { entry.promise = null; });

            cacheState.leaseEvents.set(key, entry);
            return entry.promise;
        }

        // 加载统计数据
        async function loadStats(options = {}) {
            try {
                const data = await getStats(options);
                const stats = data.dashboard;
                document.getElementById('totalCodes').textContent = stats.total_codes;
                document.getElementById('activeCodes').textContent = stats.active_codes;
                document.getElementById('totalRedemptions').textContent = stats.total_redemptions;

                const successful = Number(stats.successful_redemptions ?? 0);
                const failed = Number(stats.failed_redemptions ?? 0);
                const total = Number(stats.total_redemptions ?? 0);

                const rate = total > 0 ? ((successful / total) * 100) : null;
                document.getElementById('successRate').textContent = rate === null ? '-' : `${rate.toFixed(1)}%`;
                document.getElementById('successRateHint').textContent = total > 0 ? `${successful}/${total}` : '-';

                const usedUp = Number(stats.used_up_codes ?? 0);
                const disabled = Number(stats.disabled_codes ?? 0);
                const expired = Number(stats.expired_codes ?? 0);
                document.getElementById('codesBreakdown').textContent = `已用完 ${usedUp} · 禁用 ${disabled} · 过期 ${expired}`;

                document.getElementById('redemptionsBreakdown').textContent = `成功 ${successful} · 失败 ${failed}`;

                const todaySuccess = Number(stats.today_successful_redemptions ?? 0);
                const todayFailed = Number(stats.today_failed_redemptions ?? 0);
                const todayTotal = Number(stats.today_redemptions ?? 0);
                document.getElementById('todaySuccess').textContent = todaySuccess;
                document.getElementById('todayBreakdown').textContent = `失败 ${todayFailed} · 总计 ${todayTotal}`;
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

        // 加载兑换码列表
        async function loadCodes(options = {}) {
            const codesTable = document.getElementById('codesTable');
            codesTable.innerHTML = '<div class="loading">加载中...</div>';
            const team = document.getElementById('teamFilter').value;
            const status = document.getElementById('statusFilter').value;

            try {
                const codes = await getCodes({ team, status, force: !!options.force });
                let html = '<table><thead><tr><th>兑换码</th><th>Team</th><th>使用情况</th><th>状态</th><th>过期时间</th><th>操作</th></tr></thead><tbody>';

                codes.forEach(code => {
                    const statusBadge =
                        code.status === 'active' ? 'success' :
                        code.status === 'expired' ? 'danger' :
                        code.status === 'used_up' ? 'warning' :
                        code.status === 'deleted' ? 'danger' :
                        'warning';
                    const expires = escapeHtml(code.expires_at || '永久有效');
                    const teamName = code.team_display_name || code.team_name || code.team_key || '-';
                    const safeTeamName = escapeHtml(teamName);
                    const safeCode = escapeHtml(code.code);
                    const codeJson = JSON.stringify(code.code);

                    const toggleBtn = code.status === 'active'
                        ? `<button class="action-btn disable" onclick="updateCodeStatus(${codeJson}, 'disabled')">禁用</button>`
                        : ((code.status === 'deleted' || code.status === 'used_up')
                            ? ''
                            : `<button class="action-btn enable" onclick="updateCodeStatus(${codeJson}, 'active')">启用</button>`);

                    const statusText = escapeHtml(labelOf(LABELS.codeStatus, code.status, code.status));

                    html += `
                        <tr>
                            <td><code class="copyable" data-copy="${safeCode}" title="点击复制">${safeCode}</code></td>
                            <td><span class="team-cell" title="${safeTeamName}">${safeTeamName}</span></td>
                            <td>${code.used_count}/${code.max_uses}</td>
                            <td><span class="badge ${statusBadge}">${statusText}</span></td>
                            <td>${expires}</td>
                            <td>
                                ${toggleBtn}
                                <button class="action-btn danger" onclick="deleteCode(${codeJson})">删除</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                codesTable.innerHTML = html;
            } catch (error) {
                console.error('加载兑换码失败:', error);
                codesTable.innerHTML = '<div class="loading">加载失败</div>';
            }
        }

        // 加载兑换记录
        async function loadRedemptions(options = {}) {
            const redemptionsTable = document.getElementById('redemptionsTable');
            redemptionsTable.innerHTML = '<div class="loading">加载中...</div>';
            try {
                const redemptions = await getRedemptions({ limit: 50, force: !!options.force });
                let html = '<table><thead><tr><th>邮箱</th><th>兑换码</th><th>Team</th><th>状态</th><th>兑换时间</th><th>IP地址</th><th>操作</th></tr></thead><tbody>';

                redemptions.forEach(r => {
                    const statusBadge = r.invite_status === 'success' ? 'success' : r.invite_status === 'failed' ? 'danger' : 'warning';
                    const time = new Date(r.redeemed_at).toLocaleString();
                    const teamName = r.team_display_name || r.team_name || r.team_key || '-';
                    const safeTeamName = escapeHtml(teamName);
                    const safeEmail = escapeHtml(r.email);
                    const safeCode = escapeHtml(r.code);
                    const safeIp = escapeHtml(r.ip_address || '-');
                    const statusText = escapeHtml(labelOf(LABELS.inviteStatus, r.invite_status, r.invite_status));

                    html += `
                        <tr>
                            <td>${safeEmail}</td>
                            <td><code class="copyable" data-copy="${safeCode}" title="点击复制">${safeCode}</code></td>
                            <td><span class="team-cell" title="${safeTeamName}">${safeTeamName}</span></td>
                            <td><span class="badge ${statusBadge}">${statusText}</span></td>
                            <td>${time}</td>
                            <td>${safeIp}</td>
                            <td><button class="action-btn danger" onclick="deleteRedemption(${r.id})">删除</button></td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                redemptionsTable.innerHTML = html;
            } catch (error) {
                console.error('加载兑换记录失败:', error);
                redemptionsTable.innerHTML = '<div class="loading">加载失败</div>';
            }
        }

        // 加载Team统计
        async function loadTeamStats(options = {}) {
            const teamsTable = document.getElementById('teamsTable');
            teamsTable.innerHTML = '<div class="loading">加载中...</div>';
            try {
                const data = await getStats(options);
                const teams = data.teams;
                let html = '<table><thead><tr><th>Team</th><th>总席位</th><th>已使用</th><th>待接受</th><th>可用席位</th><th>最后更新</th></tr></thead><tbody>';

                teams.forEach(team => {
                    const time = team.last_updated ? new Date(team.last_updated).toLocaleString() : '-';
                    const teamName = team.team_display_name || team.team_name || team.team_key || '-';
                    const safeTeamName = escapeHtml(teamName);

                    html += `
                        <tr>
                            <td><strong><span class="team-cell" title="${safeTeamName}">${safeTeamName}</span></strong></td>
                            <td>${team.total_seats}</td>
                            <td>${team.used_seats}</td>
                            <td>${team.pending_invites}</td>
                            <td><strong>${team.available_seats}</strong></td>
                            <td>${time}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                teamsTable.innerHTML = html;
            } catch (error) {
                console.error('加载Team统计失败:', error);
                teamsTable.innerHTML = '<div class="loading">加载失败</div>';
            }
        }

        // 刷新Team统计（从ChatGPT API获取最新数据）
        async function refreshTeamStats() {
            const teamsTable = document.getElementById('teamsTable');
            teamsTable.innerHTML = '<div class="loading">正在从ChatGPT API刷新统计...</div>';

            try {
                const result = await fetchJson('/api/admin/teams/refresh-stats', { method: 'POST' });
                cacheState.stats.ts = 0;
                showToast(result.message || '刷新成功', 'success', 1800);
                loadTeamStats({ force: true });
                loadStats({ force: true });
            } catch (error) {
                showToast('刷新失败: ' + error.message, 'danger', 2200);
                loadTeamStats({ force: true });
            }
        }

        // 更新兑换码状态
        async function updateCodeStatus(code, status) {
            const ok = await uiConfirm(`确定要${status === 'active' ? '启用' : '禁用'}此兑换码吗?`, { title: '确认操作' });
            if (!ok) return;

            try {
                await fetchJson(`/api/admin/codes/${encodeURIComponent(code)}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                cacheState.codes.clear();
                cacheState.stats.ts = 0;

                showToast('更新成功', 'success');
                loadCodes({ force: true });
                loadStats({ force: true });
            } catch (error) {
                showToast('更新失败: ' + error.message, 'danger', 2200);
            }
        }

        async function deleteCode(code) {
            const ok = await uiConfirm(`确定要删除此兑换码吗?\n\n${code}\n\n删除后将无法兑换。`, { title: '确认删除', okText: '删除' });
            if (!ok) return;

            try {
                await fetchJson(`/api/admin/codes/${encodeURIComponent(code)}`, { method: 'DELETE' });

                cacheState.codes.clear();
                cacheState.stats.ts = 0;

                showToast('删除成功', 'success');
                loadCodes({ force: true });
                loadStats({ force: true });
            } catch (error) {
                showToast('删除失败: ' + error.message, 'danger', 2200);
            }
        }

        async function deleteRedemption(id) {
            const ok = await uiConfirm(`确定要删除此兑换记录吗?\n\nID: ${id}\n\n删除后不可恢复。`, { title: '确认删除', okText: '删除' });
            if (!ok) return;

            try {
                await fetchJson(`/api/admin/redemptions/${id}`, { method: 'DELETE' });

                cacheState.redemptions.ts = 0;
                cacheState.stats.ts = 0;

                showToast('删除成功', 'success');
                loadRedemptions({ force: true });
                loadStats({ force: true });
            } catch (error) {
                showToast('删除失败: ' + error.message, 'danger', 2200);
            }
        }

        async function bulkDeleteCodes() {
            const team = document.getElementById('teamFilter').value;
            const status = document.getElementById('statusFilter').value;

            const ok = await uiConfirmPhrase({
                title: '危险操作',
                message: `将删除当前筛选下的全部兑换码：\n\nTeam: ${team || '所有Team'}\n状态: ${status || '所有状态'}`,
                phrase: UI_CONFIRM_PHRASE
            });
            if (!ok) return;

            try {
                const result = await fetchJson('/api/admin/codes/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: UI_CONFIRM_PHRASE, team, status })
                });

                cacheState.codes.clear();
                cacheState.stats.ts = 0;

                showToast(result.message || '已删除', 'success', 1800);
                loadCodes({ force: true });
                loadStats({ force: true });
            } catch (error) {
                showToast('全部删除失败: ' + error.message, 'danger', 2400);
            }
        }

        // ==================== 成员到期/转移 ====================

        async function loadLeases(options = {}) {
            const leasesTable = document.getElementById('leasesTable');
            const eventsTable = document.getElementById('leaseEventsTable');
            leasesTable.innerHTML = '<div class="loading">加载中...</div>';
            if (eventsTable) eventsTable.innerHTML = '';

            try {
                const leases = await getLeases({ limit: 200, force: !!options.force });
                let html = '<table><thead><tr><th>邮箱</th><th>当前团队</th><th>状态</th><th>加入时间</th><th>到期时间</th><th>转移次数</th><th>操作</th></tr></thead><tbody>';

                leases.forEach(l => {
                    const email = escapeHtml(l.email || '-');
                    const team = escapeHtml(l.team_name || '-');
                    const statusKey = (l.status || '').trim();
                    const status = escapeHtml(labelOf(LABELS.leaseStatus, statusKey, statusKey || '-'));
                    const joinAt = l.join_at ? new Date(l.join_at).toLocaleString() : '-';
                    const expAt = (statusKey === 'awaiting_join') ? '待同步' : (l.expires_at ? new Date(l.expires_at).toLocaleString() : '-');
                    const count = Number(l.transfer_count ?? 0);
                    const rawEmail = (l.email || '').toLowerCase();
                    const safeEmailAttr = escapeHtml(rawEmail);

                    const badgeClass =
                        statusKey === 'active' ? 'success' :
                        statusKey === 'awaiting_join' ? 'warning' :
                        statusKey === 'awaiting_transfer' ? 'warning' :
                        statusKey === 'transferring' ? 'info' :
                        'info';

                    html += `
                        <tr>
                            <td>${email}</td>
                            <td><span class="team-cell" title="${team}">${team}</span></td>
                            <td><span class="badge ${badgeClass}">${status}</span></td>
                            <td>${joinAt}</td>
                            <td>${expAt}</td>
                            <td>${count}</td>
                            <td style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="action-btn enable" data-action="lease-view" data-email="${safeEmailAttr}" title="只查看该邮箱的转移相关记录">转移记录</button>
                                <button class="action-btn enable" data-action="lease-transfer" data-email="${safeEmailAttr}" title="对该邮箱执行一次到期检查：仅到期才会尝试转移">执行转移</button>
                                <button class="action-btn danger" data-action="lease-delete" data-email="${safeEmailAttr}" title="删除该邮箱的租约，用户将永久退出自动转移">删除</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                leasesTable.innerHTML = html;
            } catch (error) {
                console.error('加载租约失败:', error);
                leasesTable.innerHTML = '<div class="loading">加载失败</div>';
            }
        }

        async function loadLeaseEvents(email) {
            const eventsTable = document.getElementById('leaseEventsTable');
            if (!eventsTable) return;
            eventsTable.innerHTML = '<div class="loading">加载事件中...</div>';

            const target = (email || document.getElementById('leaseEmailFilter')?.value || '').trim().toLowerCase();

            try {
                const events = await getLeaseEvents({ email: target, limit: 200, force: true });
                const transferActions = new Set(['left_old_team', 'leave_old_failed', 'transferred', 'transfer_failed']);
                const filtered = (events || []).filter(e => transferActions.has((e.action || '').trim()));

                if (!filtered.length) {
                    eventsTable.innerHTML = '<div class="loading">没有转移记录</div>';
                    return;
                }
                let html = '<table><thead><tr><th>时间</th><th>邮箱</th><th>事件</th><th>原团队</th><th>新团队</th><th>说明</th></tr></thead><tbody>';
                filtered.forEach(e => {
                    const t = e.created_at ? new Date(e.created_at).toLocaleString() : '-';
                    const actionKey = (e.action || '').trim();
                    const actionText = escapeHtml(labelOf(LABELS.leaseAction, actionKey, actionKey || '-'));
                    html += `
                        <tr>
                            <td>${escapeHtml(t)}</td>
                            <td>${escapeHtml(e.email || '-')}</td>
                            <td><span class="team-cell" title="${escapeHtml(actionKey)}">${actionText}</span></td>
                            <td>${escapeHtml(e.from_team || '-')}</td>
                            <td>${escapeHtml(e.to_team || '-')}</td>
                            <td style="max-width: 420px;"><span class="team-cell" title="${escapeHtml(e.message || '')}">${escapeHtml(e.message || '') || '-'}</span></td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                eventsTable.innerHTML = html;
            } catch (error) {
                eventsTable.innerHTML = '<div class="loading">加载失败</div>';
            }
        }

        // 租约页按钮事件代理（避免 inline onclick 的引号问题）
        document.addEventListener('click', (e) => {
            const btn = e.target && e.target.closest ? e.target.closest('button[data-action]') : null;
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const email = (btn.getAttribute('data-email') || '').trim().toLowerCase();
            if (!action || !email) return;

            if (action === 'lease-view') loadLeaseEvents(email);
            else if (action === 'lease-transfer') runTransferForEmail(email);
            else if (action === 'lease-delete') deleteLease(email);
        }, true);

        async function syncJoinTimes() {
            const email = (document.getElementById('leaseEmailFilter')?.value || '').trim().toLowerCase();
            const msg = email
                ? `将尝试为该邮箱“自动补开始计时”。\n\n说明：仅当系统能确认该邮箱已加入（例如邀请已 accepted/completed）时，才能补上。\n\n邮箱: ${email}\n\n继续？`
                : '将为 awaiting_join 的邮箱“自动补开始计时”。\n\n说明：仅当系统能确认已加入（例如邀请已 accepted/completed）时，才能补上。\n\n继续？';

            const ok = await uiConfirm(msg, { title: '自动补开始计时' });
            if (!ok) return;

            try {
                const res = await fetchJson('/api/admin/leases/sync-join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(email ? { email } : { limit: 80 })
                });
                showToast(res.message || '同步完成', 'success', 2000);
                cacheState.leases.ts = 0;
                cacheState.leaseEvents.clear();
                loadLeases({ force: true });
            } catch (e) {
                showToast('同步失败: ' + e.message, 'danger', 2600);
            }
        }

        async function runTransferOnce() {
            const teams = await getTeams({ force: false });
            if (!teams || teams.length < 2) {
                showToast('请先在「Team管理」至少配置 2 个 Team（否则无法转移到新 Team）', 'danger', 2600);
                return;
            }
            const email = (document.getElementById('leaseEmailFilter')?.value || '').trim().toLowerCase();
            const msg = email
                ? `将尝试对该邮箱执行一次到期转移。\n\n仅当该邮箱已到期，且你已配置至少 2 个 Team 时，才会真的发送新 Team 邀请（自动退出旧 Team 需服务端配置）。\n\n邮箱: ${email}\n\n继续？`
                : '将尝试执行一轮到期转移。\n\n仅对“已到期”的邮箱生效，且需要至少 2 个 Team 才能转移到新 Team（自动退出旧 Team 需服务端配置）。\n\n继续？';

            const ok = await uiConfirm(msg, { title: '执行转移' });
            if (!ok) return;

            try {
                const res = await fetchJson('/api/admin/leases/run-transfer-once', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(email ? { email } : { limit: 20 })
                });
                const moved = Number(res?.data?.moved ?? 0);
                showToast(res.message || '执行完成', moved > 0 ? 'success' : 'warning', 2400);
                cacheState.leases.ts = 0;
                cacheState.leaseEvents.clear();
                loadLeases({ force: true });
            } catch (e) {
                showToast('执行失败: ' + e.message, 'danger', 2600);
            }
        }

        async function runTransferForEmail(email) {
            const teams = await getTeams({ force: false });
            if (!teams || teams.length < 2) {
                showToast('请先在「Team管理」至少配置 2 个 Team（否则无法转移到新 Team）', 'danger', 2600);
                return;
            }
            const ok = await uiConfirm(`将对该邮箱执行一次“到期转移”（仅在到期时会真正转移）。\\n\\n邮箱: ${email}`, { title: '执行转移' });
            if (!ok) return;
            try {
                const res = await fetchJson('/api/admin/leases/run-transfer-once', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const moved = Number(res?.data?.moved ?? 0);
                showToast(res.message || '执行完成', moved > 0 ? 'success' : 'warning', 2400);
                cacheState.leases.ts = 0;
                cacheState.leaseEvents.clear();
                loadLeases({ force: true });
            } catch (e) {
                showToast('执行失败: ' + e.message, 'danger', 2600);
            }
        }

        async function deleteLease(email) {
            const ok = await uiConfirm(`确定要删除 ${email} 的租约吗？\n\n删除后该用户将永久退出自动转移。`, { title: '删除租约' });
            if (!ok) return;
            try {
                const res = await fetchJson('/api/admin/leases/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, delete_events: true })
                });
                showToast(res.message || '删除成功', 'success', 2000);
                cacheState.leases.ts = 0;
                cacheState.leaseEvents.clear();
                loadLeases({ force: true });
            } catch (e) {
                showToast('删除失败: ' + e.message, 'danger', 2600);
            }
        }

        async function openLeaseUpsert() {
            const teams = await getTeams({ force: true });
            const options = teams.map(t => `<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`).join('');

            const bodyHtml = `
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <div style="font-size:13px; color:#86868b; line-height:1.5;">
                        录入后该邮箱会纳入“到期转移”体系。你只需要填一个时间即可：
                        <div style="margin-top:6px; display:flex; flex-direction:column; gap:4px;">
                            <div>1）只填「到期时间」：你希望它哪天到期（系统会自动反推“开始计时”）</div>
                            <div>2）填「开始计时」：从哪天开始算周期（系统会自动算到期时间）</div>
                        </div>
                    </div>
                    <div>
                        <div style="margin-bottom:6px; font-weight:500;">邮箱</div>
                        <input id="leaseUpsertEmail" class="ui-input" placeholder="user@example.com" />
                    </div>
                    <div>
                        <div style="margin-bottom:6px; font-weight:500;">当前 Team</div>
                        <select id="leaseUpsertTeam" class="ui-input">${options}</select>
                    </div>
                    <div>
                        <div style="margin-bottom:6px; font-weight:500;">开始计时（可选）</div>
                        <input id="leaseUpsertJoinAt" type="datetime-local" class="ui-input" />
                        <div style="margin-top:6px; font-size:12px; color:#86868b;">含义：从这个时间点开始算一个周期（例如 1 个月）。</div>
                    </div>
                    <div>
                        <div style="margin-bottom:6px; font-weight:500;">到期时间（可选）</div>
                        <input id="leaseUpsertExpiresAt" type="datetime-local" class="ui-input" />
                        <div style="margin-top:6px; font-size:12px; color:#86868b;">含义：你希望它到期的时间点（只填这个最省心）。</div>
                    </div>
                </div>
            `;

            const cancel = makeButton({ text: '取消', className: 'action-btn disable', onClick: () => closeModal() });
            const ok = makeButton({
                text: '保存',
                className: 'refresh-btn',
                onClick: async () => {
                    const email = (document.getElementById('leaseUpsertEmail').value || '').trim().toLowerCase();
                    const team_name = (document.getElementById('leaseUpsertTeam').value || '').trim();
                    const join_at = (document.getElementById('leaseUpsertJoinAt').value || '').trim();
                    const expires_at = (document.getElementById('leaseUpsertExpiresAt').value || '').trim();
                    if (!email || !team_name) {
                        showToast('请填写邮箱和 Team', 'danger', 2200);
                        return;
                    }
                    try {
                        const res = await fetchJson('/api/admin/leases', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, team_name, join_at, expires_at })
                        });
                        closeModal();
                        showToast(res.message || '已录入', 'success', 2000);
                        cacheState.leases.ts = 0;
                        loadLeases({ force: true });
                    } catch (e) {
                        showToast('录入失败: ' + e.message, 'danger', 2600);
                    }
                }
            });

            openModal({ title: '录入邮箱到期租约', bodyHtml, actions: [cancel, ok] });
        }

        async function bulkDeleteRedemptions() {
            const ok = await uiConfirmPhrase({
                title: '危险操作',
                message: '将删除全部兑换记录（不可恢复）。',
                phrase: UI_CONFIRM_PHRASE
            });
            if (!ok) return;

            try {
                const result = await fetchJson('/api/admin/redemptions/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: UI_CONFIRM_PHRASE })
                });

                cacheState.redemptions.ts = 0;
                cacheState.stats.ts = 0;

                showToast(result.message || '已删除', 'success', 1800);
                loadRedemptions({ force: true });
                loadStats({ force: true });
            } catch (error) {
                showToast('全部删除失败: ' + error.message, 'danger', 2400);
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', function() {
            loadStats();
            loadTeamFilterOptions(); // 加载Team筛选选项
            loadCodes();

            // 每30秒自动刷新统计
            setTimeout(() => {
                // 预加载其它Tab，减少首次点击卡顿
                loadRedemptions();
                loadTeamStats();
                loadTeamList();
            }, 200);

            setInterval(() => loadStats({ force: true }), 30000);
        });

        // 加载Team筛选选项
        async function loadTeamFilterOptions(options = {}) {
            try {
                const teamFilter = document.getElementById('teamFilter');
                const teams = await getTeams(options);

                // 清空现有选项(除了"所有Team")
                teamFilter.innerHTML = '<option value="">所有Team</option>';

                // 添加每个Team作为选项
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.name;
                    option.textContent = team.name;
                    teamFilter.appendChild(option);
                });
            } catch (error) {
                console.error('加载Team列表失败:', error);
            }
        }

        // ==================== Team 管理功能 ====================

        let currentEditingTeamIndex = null;

        // 加载 Team 列表
        async function loadTeamList(options = {}) {
            const teamListTable = document.getElementById('teamListTable');
            teamListTable.innerHTML = '<div class="loading">加载中...</div>';
            try {
                const teams = await getTeams(options);
                let html = '<table><thead><tr><th>Team名称</th><th>邮箱</th><th>Account ID</th><th>Token状态</th><th>操作</th></tr></thead><tbody>';

                teams.forEach(team => {
                    const tokenBadge = team.has_token ?
                        '<span class="badge success">已配置</span>' :
                        '<span class="badge warning">未配置</span>';

                    const accountId = team.account_id || '';
                    const accountIdDisplay = accountId ? `${accountId.substring(0, 16)}...` : '-';
                    const safeName = escapeHtml(team.name);
                    const safeEmail = escapeHtml(team.email);

                    html += `
                        <tr>
                            <td><strong><span class="team-cell" title="${safeName}">${safeName}</span></strong></td>
                            <td>${safeEmail}</td>
                            <td><code>${accountIdDisplay}</code></td>
                            <td>${tokenBadge}</td>
                            <td>
                                <button class="action-btn enable" data-team-action="edit" data-index="${team.index}">编辑</button>
                                <button class="action-btn enable" data-team-action="generate" data-index="${team.index}" data-team-name="${safeName}">生成兑换码</button>
                                <button class="action-btn disable" data-team-action="delete" data-index="${team.index}" data-team-name="${safeName}">删除</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                teamListTable.innerHTML = html;
            } catch (error) {
                console.error('加载Team列表失败:', error);
                teamListTable.innerHTML = '<div class="loading">加载失败</div>';
            }
        }

        // 添加新 Team
        function addTeam() {
            currentEditingTeamIndex = null;
            document.getElementById('modalTitle').textContent = '添加Team';
            document.getElementById('teamName').value = '';
            document.getElementById('teamEmail').value = '';
            document.getElementById('teamUserId').value = '';
            document.getElementById('teamAccountId').value = '';
            document.getElementById('teamOrgId').value = '';
            document.getElementById('teamAccessToken').value = '';
            document.getElementById('teamModal').style.display = 'flex';
        }

        // 编辑 Team
        async function editTeam(index) {
            currentEditingTeamIndex = index;
            document.getElementById('modalTitle').textContent = '编辑Team';

            try {
                const teams = await getTeams();
                const team = teams.find(t => t.index === index) || teams[index];
                if (!team) {
                    showToast('Team不存在', 'danger');
                    return;
                }

                document.getElementById('teamName').value = team.name;
                document.getElementById('teamEmail').value = team.email;
                document.getElementById('teamUserId').value = team.user_id;
                document.getElementById('teamAccountId').value = team.account_id;
                document.getElementById('teamOrgId').value = team.org_id;
                document.getElementById('teamAccessToken').value = ''; // 不显示已有token
                document.getElementById('teamModal').style.display = 'flex';
            } catch (error) {
                showToast('加载Team信息失败: ' + error.message, 'danger', 2200);
            }
        }

        // 保存 Team
        async function saveTeam() {
            const name = document.getElementById('teamName').value.trim();
            const email = document.getElementById('teamEmail').value.trim();
            const userId = document.getElementById('teamUserId').value.trim();
            const accountId = document.getElementById('teamAccountId').value.trim();
            const orgId = document.getElementById('teamOrgId').value.trim();
            const accessToken = document.getElementById('teamAccessToken').value.trim();

            if (!name || !email || !userId || !accountId || !orgId) {
                showToast('请填写所有必填字段', 'danger', 2000);
                return;
            }

            // 添加新Team时必须提供token
            if (currentEditingTeamIndex === null && !accessToken) {
                showToast('添加新Team时必须提供Access Token', 'danger', 2200);
                return;
            }

            const payload = { name, email, user_id: userId, account_id: accountId, org_id: orgId };
            if (accessToken) {
                payload.access_token = accessToken;
            }

            try {
                let result;
                if (currentEditingTeamIndex === null) {
                    // 添加新Team
                    result = await fetchJson('/api/admin/teams', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // 更新现有Team
                    result = await fetchJson(`/api/admin/teams/${currentEditingTeamIndex}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                showToast(result.message || '保存成功', 'success', 1800);
                closeTeamModal();
                cacheState.teams.ts = 0;
                loadTeamList({ force: true });
                loadTeamFilterOptions({ force: true }); // 刷新Team筛选选项
            } catch (error) {
                if ((error.message || '').includes('未登录')) {
                    window.location.href = '/admin/login';
                    return;
                }
                showToast('保存失败: ' + error.message, 'danger', 2400);
            }
        }

        // 删除 Team
        async function deleteTeam(index, name) {
            const ok = await uiConfirm(`确定要删除Team "${name}" 吗？\n\n此操作不可恢复！`, { title: '确认删除', okText: '删除' });
            if (!ok) return;

            try {
                const result = await fetchJson(`/api/admin/teams/${index}?cleanup=true`, { method: 'DELETE' });
                showToast(result.message || '删除成功', 'success', 2400);
                cacheState.teams.ts = 0;
                cacheState.codes.clear();
                cacheState.redemptions.ts = 0;
                cacheState.stats.ts = 0;
                loadTeamList({ force: true });
                loadTeamFilterOptions({ force: true }); // 刷新Team筛选选项
                loadCodes({ force: true });
                loadTeamStats({ force: true });
                loadStats({ force: true });
            } catch (error) {
                if ((error.message || '').includes('未登录')) {
                    window.location.href = '/admin/login';
                    return;
                }
                showToast('删除失败: ' + error.message, 'danger', 2400);
            }
        }

        // 关闭 Team 对话框
        function closeTeamModal() {
            document.getElementById('teamModal').style.display = 'none';
            currentEditingTeamIndex = null;
        }

        // 显示生成兑换码对话框
        function showGenerateCodesModal(index, teamName) {
            currentEditingTeamIndex = index;
            document.getElementById('genTeamName').value = teamName;
            document.getElementById('genCount').value = 4;
            document.getElementById('genMaxUses').value = 1;
            document.getElementById('genExpiresDays').value = '';
            document.getElementById('genAutoTransfer').checked = true;  // 默认启用
            document.getElementById('generateCodesModal').style.display = 'flex';
        }

        // 生成兑换码
        async function generateCodes() {
            const count = parseInt(document.getElementById('genCount').value);
            const maxUses = parseInt(document.getElementById('genMaxUses').value);
            const expiresDaysInput = document.getElementById('genExpiresDays').value;
            const expiresDays = expiresDaysInput ? parseInt(expiresDaysInput) : null;
            const teamName = (document.getElementById('genTeamName').value || '').trim();
            const autoTransferEnabled = document.getElementById('genAutoTransfer').checked;

            if (!count || count < 1 || count > 1000) {
                showToast('生成数量必须在 1-1000 之间', 'danger', 2200);
                return;
            }

            if (!maxUses || maxUses < 1) {
                showToast('最大使用次数必须大于 0', 'danger', 2200);
                return;
            }

            const payload = { count, max_uses: maxUses, auto_transfer_enabled: autoTransferEnabled };
            if (teamName) payload.team_name = teamName;
            if (expiresDays) {
                payload.expires_days = expiresDays;
            }

            try {
                const result = await fetchJson(`/api/admin/teams/${currentEditingTeamIndex}/generate-codes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const codes = result.data.codes;
                const codesText = codes.join('\n');

                await copyText(codesText);

                const copyBtn = makeButton({
                    text: '复制全部',
                    className: 'action-btn enable',
                    onClick: () => {
                        Promise.resolve(copyText(codesText)).finally(() => closeModal());
                    }
                });
                const okBtn = makeButton({
                    text: '关闭',
                    className: 'refresh-btn',
                    onClick: () => closeModal()
                });

                openModal({
                    title: `生成成功（${codes.length} 个）`,
                    bodyHtml: `
                        <div style="margin-bottom:10px;">兑换码已复制到剪贴板。</div>
                        <textarea class="ui-input" style="height: 180px; font-family: 'SF Mono', Monaco, monospace;" readonly>${escapeHtml(codesText)}</textarea>
                        <div style="margin-top:10px; color:#86868b; font-size:12px;">也可以点击表格中的兑换码直接复制。</div>
                    `,
                    actions: [copyBtn, okBtn]
                });
                closeGenerateCodesModal();
                cacheState.codes.clear();
                cacheState.stats.ts = 0;
                cacheState.teams.ts = 0;
                loadCodes({ force: true });
                loadStats({ force: true });
                loadTeamStats({ force: true });

            } catch (error) {
                if ((error.message || '').includes('未登录')) {
                    window.location.href = '/admin/login';
                    return;
                }
                showToast('生成失败: ' + error.message, 'danger', 2400);
            }
        }

        // 关闭生成兑换码对话框
        function closeGenerateCodesModal() {
            document.getElementById('generateCodesModal').style.display = 'none';
            currentEditingTeamIndex = null;
        }
    </script>
</body>
</html>
