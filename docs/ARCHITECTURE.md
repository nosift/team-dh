# 系统架构说明

## 两个独立系统

本项目包含两个独立的系统，它们各自有不同的用途和部署方式：

---

## 1. 兑换码系统（Team-DH）

### 部署位置
- **Zeabur 云平台**（或其他容器平台）
- 公网访问
- 24/7 运行

### 主要功能
- 兑换码管理（生成、启用/禁用、删除）
- 用户兑换流程（邮箱 + 兑换码）
- 自动到期转移系统（按月自动转移到新 Team）
- 管理后台（Team 管理、兑换记录、统计）
- 分组管理
- 监控告警

### 技术栈
- Python 3.12+, Flask, SQLite
- HTML/CSS/JavaScript
- Docker, Gunicorn

### 访问方式
```
用户兑换页面: https://your-domain.com/
管理后台: https://your-domain.com/admin
```

---

## 2. 自动注册系统

### 部署位置
- **本地运行**
- 需要浏览器环境
- 按需运行（不需要 24/7）

### 主要功能
- 自动注册 OpenAI 账号
- 使用 DuckMail 临时邮箱
- 自动邀请到 Team
- Codex OAuth 授权
- 批量注册

### 技术栈
- Python 3.x
- Selenium + undetected_chromedriver
- Requests

### 运行方式
```bash
cd "openai注册机+自动拉team+cpa上号"
python openai_register.py
```

---

## 为什么保持独立？

### 1. 部署环境不同

**兑换系统（云端）**:
- 无头环境（Headless）
- 无浏览器支持
- 容器化部署
- 资源受限

**注册系统（本地）**:
- 需要浏览器环境
- 需要图形界面（验证码、人机验证）
- 资源充足
- 可以手动干预

### 2. 运行频率不同

**兑换系统**:
- 24/7 持续运行
- 实时响应用户请求
- 后台自动转移

**注册系统**:
- 按需运行
- 批量注册后停止
- 不需要持续运行

### 3. 安全性考虑

**兑换系统**:
- 公网暴露
- 需要严格的安全措施
- 只处理兑换逻辑

**注册系统**:
- 本地运行
- 不暴露到公网
- 包含敏感操作（注册、验证）

### 4. 维护成本

**独立部署**:
- ✅ 各自独立更新
- ✅ 互不影响
- ✅ 故障隔离
- ✅ 简化部署

**集成部署**:
- ❌ 需要在云端支持浏览器
- ❌ 增加部署复杂度
- ❌ 资源消耗大
- ❌ 维护困难

---

## 工作流程

### 推荐流程

```
┌─────────────────────────────────────────────────────────┐
│  1. 本地运行注册系统                                      │
│     - 批量注册 OpenAI 账号                                │
│     - 自动邀请到 Team                                     │
│     - 保存到 registered_accounts.csv                      │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  2. 云端运行兑换系统                                      │
│     - 生成兑换码                                          │
│     - 用户兑换                                            │
│     - 自动转移管理                                        │
└─────────────────────────────────────────────────────────┘
```

### 数据流

```
注册系统（本地）                兑换系统（云端）
     ↓                              ↓
注册账号 → 邀请到 Team          生成兑换码
     ↓                              ↓
保存 CSV                        用户兑换
                                    ↓
                              自动转移管理
```

---

## 各自的优势

### 兑换系统（云端）

**优势**:
- ✅ 24/7 可用
- ✅ 公网访问
- ✅ 自动化管理
- ✅ 数据持久化
- ✅ 监控告警

**适用场景**:
- 对外提供兑换服务
- 长期运营
- 自动化管理

### 注册系统（本地）

**优势**:
- ✅ 浏览器支持
- ✅ 手动干预
- ✅ 灵活控制
- ✅ 安全性高
- ✅ 资源充足

**适用场景**:
- 批量注册账号
- 初始化 Team
- 测试验证

---

## 如果需要数据同步

虽然两个系统独立运行，但如果需要同步数据，可以通过以下方式：

### 方式 1: 手动导入（推荐）

```bash
# 1. 本地注册完成后，导出 CSV
# registered_accounts.csv 已自动生成

# 2. 在云端管理后台手动录入
# 访问 https://your-domain.com/admin
# 进入 "到期/转移" 标签页
# 点击 "手动录入" 按钮
```

### 方式 2: API 导入

```bash
# 1. 本地读取 CSV
import csv

with open('registered_accounts.csv', 'r') as f:
    reader = csv.DictReader(f)
    for row in reader:
        email = row['email']

        # 2. 调用云端 API
        requests.post('https://your-domain.com/api/admin/leases',
            json={
                'email': email,
                'team_name': 'luo',
                'team_account_id': '...',
            },
            cookies={'session': 'admin_session'}
        )
```

### 方式 3: 数据库导入

```bash
# 1. 导出本地数据
sqlite3 local.db "SELECT * FROM accounts" > accounts.sql

# 2. 上传到云端
scp accounts.sql user@server:/path/

# 3. 导入到云端数据库
sqlite3 /data/redemption.db < accounts.sql
```

---

## 总结

### 推荐架构：独立部署 ✅

**理由**:
1. 部署环境不同（云端 vs 本地）
2. 运行频率不同（持续 vs 按需）
3. 安全性考虑（公网 vs 本地）
4. 维护成本低（独立更新）

### 不推荐：集成部署 ❌

**问题**:
1. 云端需要支持浏览器（复杂）
2. 资源消耗大（成本高）
3. 部署复杂（维护难）
4. 安全风险（暴露注册逻辑）

---

## 文件结构

```
team-dh/
├── 兑换系统（云端部署）
│   ├── web_server.py          # Web 服务
│   ├── database.py            # 数据库
│   ├── transfer_service.py    # 自动转移
│   ├── static/                # 前端页面
│   └── docs/                  # 文档
│
└── openai注册机+自动拉team+cpa上号/（本地运行）
    ├── openai_register.py     # 注册脚本
    ├── registered_accounts.csv # 注册记录
    └── invite_tracker.json    # 邀请追踪
```

---

## 最佳实践

1. **兑换系统**
   - 部署到 Zeabur/Railway/Fly.io
   - 配置域名和 HTTPS
   - 定期备份数据库
   - 监控运行状态

2. **注册系统**
   - 本地运行
   - 定期批量注册
   - 保存注册记录
   - 手动同步到云端（如需要）

3. **数据管理**
   - 注册系统：保存 CSV 记录
   - 兑换系统：管理租约和转移
   - 定期对账和清理

---

**结论**: 保持两个系统独立运行是最佳方案，各司其职，简单高效。
